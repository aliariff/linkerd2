#!/bin/bash

set -eu

if [ $# -ne 0 ]; then
    echo "no arguments allowed for $(basename $0), given: $@" >&2
    exit 64
fi

bindir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
rootdir="$( cd $bindir/.. && pwd )"

. $bindir/_docker.sh
. $bindir/_tag.sh

dockerfile=$rootdir/grafana/Dockerfile

extra=""
if [ -n "${DOCKER_BUILD_ARCH:-}" ]; then
    extra+=" --platform $DOCKER_BUILD_ARCH"
    extra+=" --pull" # IMPORTANT: always try to pull the image with correct platform
fi

docker_build grafana "$(head_root_tag)" $dockerfile $extra
