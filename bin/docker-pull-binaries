#!/usr/bin/env bash

set -eu

if [ $# -eq 1 ]; then
    tag=${1:-}
else
    echo "usage: ${0##*/} tag" >&2
    exit 64
fi

bindir=$( cd "${BASH_SOURCE[0]%/*}" && pwd )
rootdir=$( cd "$bindir"/.. && pwd )

# shellcheck source=_docker.sh
. "$bindir"/_docker.sh

workdir=$rootdir/target/release
mkdir -p "$workdir"

# create shorttag where eventual initial v in tag is stripped
shorttag=${tag#v}

copy_binary() {
  id=$1
  os=$2
  ext=$3

  filepath=$workdir/linkerd2-cli-$shorttag-$ext
  docker cp "$id:/out/linkerd-$os" "$filepath"
  openssl dgst -sha256 "$filepath" | awk '{print $2}' > "$filepath.sha256"
  echo "$filepath"
}

for arch in amd64 arm64 arm ; do
  # pull specific image architecture
  pull=$(docker pull --platform $arch "$(docker_repo cli-bin):$tag")

  # create the cli-bin container in order to extract the binaries
  id=$(docker create "$(docker_repo cli-bin):$tag")

  if [ "$arch" = amd64 ]; then
    # copy mac and windows binaries
    copy_binary $id "darwin" "darwin"
    copy_binary $id "windows" "windows.exe"
  fi

  # copy linux binaries with architecture name
  copy_binary $id "linux" "linux-$arch"

  # cleanup the cli-bin container when finished
  docker rm "$id" > /dev/null
done
